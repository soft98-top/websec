# HTTP 请求走私

> HTTP request smuggling：https://portswigger.net/web-security/request-smuggling

## 什么是HTTP请求走私？

HTTP请求走私是一种技术，用于干扰web站点处理从一个或多个用户收到的HTTP请求序列的方式。请求走私漏洞在本质上通常是危险的，允许攻击者绕过安全控制，获得对敏感数据的未经授权的访问，并直接危及其他应用程序用户。

## HTTP请求走私攻击会发生什么？

今天的web应用程序经常在用户和最终的应用程序逻辑之间使用HTTP服务器链。用户将请求发送到前端服务器(有时称为负载平衡器或反向代理)，该服务器将请求转发到一个或多个后端服务器。在现代基于云的应用程序中，这种类型的架构越来越普遍，在某些情况下是不可避免的。

当前端服务器将HTTP请求转发到后端服务器时，它通常会通过同一个后端网络连接发送多个请求，因为这样效率更高、性能更好。协议非常简单:HTTP请求一个接一个发送，接收服务器解析HTTP请求头，以确定一个请求在哪里结束，下一个请求在哪里开始:

![image.png](https://cdn.nlark.com/yuque/0/2020/png/2398693/1603358401037-a31ddaaa-f5f0-4349-9fbd-1933c748a505.png)

在这种情况下，前端和后端系统必须就请求之间的边界达成一致。否则，攻击者可能会发送一个模棱两可的请求，使得前端和后端系统产生不同的解释:

![image.png](https://cdn.nlark.com/yuque/0/2020/png/2398693/1603358480055-0b514672-9946-4e7f-92fc-f9850ce43d3d.png)

在这里，攻击者使其前端请求的一部分被后端服务器解释为下一个请求的开始。它有效地预置到下一个请求，因此可能会干扰应用程序处理该请求的方式。这是一个请求走私攻击，它可以有毁灭性的结果。

## HTTP请求走私漏洞是怎么产生的？

大多数HTTP请求走私漏洞的出现，是因为HTTP规范提供了两种不同的方式来指定请求的结束位置： `Content-Length` 和 `Transfer-Encoding` 。

`Content-Length`很简单:它以字节为单位指定消息体的长度。例如:

```
POST /search HTTP/1.1
Host: normal-website.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 11

q=smuggling
```

`Transfer-Encoding`可用于指定消息体使用分块编码。这意味着消息体包含一个或多个数据块。每个块由以字节为单位(以十六进制表示)的块大小组成，后面是换行，然后是块内容。消息以大小为零的块结束。例如:

```
POST /search HTTP/1.1
Host: normal-website.com
Content-Type: application/x-www-form-urlencoded
Transfer-Encoding: chunked

b
q=smuggling
0
```

由于HTTP规范提供了两种不同的方法来指定HTTP消息的长度，因此单个消息可以同时使用两种方法，这样它们就会相互冲突。HTTP规范试图防止这个问题，它规定，如果内容长度头和传输编码头同时存在，那么应该忽略内容长度头。当只有一台服务器在运行时，这可能足以避免歧义，但当两个或多个服务器链接在一起时就不行了。在这种情况下，问题可能会因为两个原因产生:

- - 有些服务器不支持请求中头的`Transfer-Encoding`。
  - 如果头以某种方式混淆，一些支持`Transfer-Encoding`的服务器可能会被诱导不处理它。

如果前端和后端服务器在`Transfer-Encoding`(可能混淆)方面的行为不同，那么它们可能不同意连续请求之间的边界，从而导致请求走私漏洞。

## 如何完成一个HTTP请求走私攻击？

请求走私攻击包括将`Content-Length` 和 `Transfer-Encoding`放到单个HTTP请求中，并对它们进行操作，以便前端和后端服务器以不同的方式处理请求。具体的方式取决于两个服务器的行为:

- - CL.TE: 前端服务器使用`Content-Length`，后端服务器使用`Transfer-Encoding`。
  - TE.CL: 前端服务器使用`Transfer-Encoding`，后端服务器使用`Content-Length`。
  - TE.TE: 前端和后端服务器都支持`Transfer-Encoding`，但是通过以某种方式混淆头，可以诱导其中一个服务器不处理它。

## 如何阻止HTTP请求走私漏洞？

HTTP请求走私漏洞出现在以下情况:前端服务器通过相同的网络连接将多个请求转发到后端服务器，而用于后端连接的协议带来了两个服务器不同意请求边界的风险。一些防止HTTP请求走私漏洞的通用方法如下:

- - 禁用后端连接的重用，以便通过单独的网络连接发送每个后端请求。
  - 对于后端连接使用HTTP/2，因为该协议可以防止请求之间的边界不明确。
  - 对前端和后端服务器使用完全相同的web服务器软件，以便它们对请求之间的边界达成一致。

在某些情况下，可以通过使前端服务器规范化不明确的请求，或使后端服务器拒绝不明确的请求并关闭网络连接来避免漏洞。但是，这些方法可能比上面识别的一般缓解方法更容易出错。