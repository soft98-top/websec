# 7-Vulnerability Scanning

## 漏洞扫描概述和注意事项

### 漏洞扫描器是怎么工作的？

漏洞扫描器的实现各不相同，但通常遵循标准的工作流。大多数自动扫描器将:

1. 检测目标是否启动并运行。

2. 根据配置执行完整或部分端口扫描。
3. 使用常用的指纹技术识别操作系统。

4. 尝试使用常见的技术来标识正在运行的服务，如横幅抓取、服务行为标识或文件发现。

5. 执行签名匹配过程以发现漏洞。

一些漏洞扫描器可以配置为在检测时利用漏洞。这可以减少误报的可能性，但也增加了崩溃服务的风险。一定要仔细检查扫描仪的选项。

### 人工 VS 自动扫描

在评估过程中，我们应该结合人工和自动扫描技术，但适当的平衡会随着经验变得更加明显。

对远程目标网络的人工审查不可避免地会耗费大量资源和时间。由于这种方法严重依赖于人工交互和重复性任务，所以也容易出现漏洞被忽略的错误。尽管如此，red-teaming 尤其需要精确度和最小的网络占用，以尽可能长时间不被发现。在这些情况下使用自动扫描仪不是最好的方法。此外，手动分析允许发现复杂的、逻辑上的漏洞，而使用任何类型的自动扫描器都很难发现这些漏洞。

然而，当在与传统安全评估相关的典型时间限制下进行大型工作时，自动化漏洞扫描器是非常宝贵的。无论是在整个目标网络上使用通用扫描器，还是针对单个专用主机使用通用扫描器，我们都可以在更短的时间内建立基线。这些基线允许我们验证容易检测到的漏洞，或者至少帮助我们了解目标的一般安全态势。

虽然漏洞扫描是无价的，但它也有缺点。扫描配置可能很复杂，默认设置可能会损害目标。例如，许多扫描器可以也将尝试强行使用弱密码。在约定期间，应该严格控制蛮力技术，因为它们可能导致帐户锁定，从而导致客户大量停机。在执行扫描之前，务必了解漏洞扫描器的工作方式以及它的功能。

### 互联网扫描 VS 内部扫描

互联网扫描和内部扫描在目标上就存在着差异，例如互联网就不会接收到ARP协议的探测，然后与目标的连接速度不仅影响着扫描的速度，如果目标主机是比较落后的，还有可能受到大流量扫描的影响。

为了获得更好的扫描结果，首先考虑调节扫描速度和超时值。一旦你对结果的质量感到满意，你就可以开始逐步增加速度，直到达到一个良好的平衡。

### 已验证扫描 VS 未验证扫描

大多数扫描器都可以配置为运行经过身份验证的扫描，其中扫描器使用一组有效凭据登录到目标。在大多数情况下，通过身份验证的扫描使用特权用户帐户，以便对目标系统有最佳的可见性。

经过验证的扫描生成大量额外信息，并以更长的扫描时间为代价产生更准确的结果。尽管在渗透测试期间可以使用经过身份验证的扫描(例如，使用发现的凭证)，但它通常在补丁管理过程中使用。

## Nessus 漏洞扫描

### 安装

去网站下载文件：https://www.tenable.com/downloads/nessus

然后在文件所在位置打开终端： `sudo apt install ./Nessuss-X.X.X.deb` 

启动： `sudo systemctl start nessusd` 

在浏览器访问（注意一定是https）： `https://localhost:8834/` 

因为他是自生成的证书，浏览器会提示错误，大概就是连接不安全之类的，直接点Advanced -> Accept and continue

之后就会进入初始化的界面，选择Nessus Essentials，这个是免费的，有相应的功能和扫描IP数量限制，不过足够了。

![image.png](https://cdn.nlark.com/yuque/0/2020/png/2398693/1605077914450-041c7bd5-5015-4cea-96cb-b953edca50c7.png)

然后我们用邮箱去申请一个激活码，填写邮箱和名字（随便写），点击Email就可以了，会有右键发送到指定邮箱：

![image.png](https://cdn.nlark.com/yuque/0/2020/png/2398693/1605078019126-9ebf107a-2347-4816-8340-b71bc4a7fc4a.png)

用接收到的激活码激活：

![image.png](https://cdn.nlark.com/yuque/0/2020/png/2398693/1605078040821-410baef5-1be4-4787-89f3-7d757e793544.png)

然后会让你注册一个本地账户，之后在机器上就可以用这个账户登录：

![image.png](https://cdn.nlark.com/yuque/0/2020/png/2398693/1605078089312-dce88c19-ff8e-4561-8931-27789d3d2174.png)

之后Nessus会开始下载插件之类的，这个需要一段时间，看个人的网络吧：

![image.png](https://cdn.nlark.com/yuque/0/2020/png/2398693/1605078140361-987bce46-e1b9-4efb-86f6-75e947143bec.png)

### 新建扫描

Nessus初始化完之后，进入主界面，右上角有一个New Scan，点击创建一个新的扫描：

![image.png](https://cdn.nlark.com/yuque/0/2020/png/2398693/1605078250317-12d96efe-b2d1-4940-909d-a8c889f0bd05.png)

Nessus支持多种扫描：

Basic Network Scan，基本的网络扫描，使用适合针对各种目标类型使用的各种检查进行泛型扫描。

Credentialed Patch Audit，受到信任补丁审计，枚举缺失补丁的已验证扫描。

Web Application Tests，Web应用程序测试，用于发现Web应用程序中发布的漏洞的专门扫描。

Spectre and Meltdown，幽灵和崩溃，目标扫描幽灵和崩溃漏洞。

...

#### Basic Network Scan

![image.png](https://cdn.nlark.com/yuque/0/2020/png/2398693/1605078585555-0668fdf4-0bff-4910-be34-b36109247ba5.png)

Name就是个这个扫描起一个名字，Targets用于定义被扫描的目标。

![image.png](https://cdn.nlark.com/yuque/0/2020/png/2398693/1605078596063-f25a4296-491a-409d-8dee-96787ce05e43.png)

可以点击左侧DISCOVERY - Scan Type - Custom设置端口扫描范围

![image.png](https://cdn.nlark.com/yuque/0/2020/png/2398693/1605078778940-05e889a4-f2ad-4fbf-a7bb-f52b7c290eff.png)

![image.png](https://cdn.nlark.com/yuque/0/2020/png/2398693/1605078786936-66696721-99f0-47f9-ae20-7686bf3527f0.png)

![image.png](https://cdn.nlark.com/yuque/0/2020/png/2398693/1605078798492-6e0f8c10-92ac-4700-9e31-5175423bc99a.png)

然后在点击下方Save旁边的下拉箭头，然后点击Lunch即可开始扫描。

![image.png](https://cdn.nlark.com/yuque/0/2020/png/2398693/1605078857734-3f75a27f-1a0d-46a7-8f56-7d47b1efa31c.png)

扫描进行中：

![image.png](https://cdn.nlark.com/yuque/0/2020/png/2398693/1605078878001-66ed609f-a3aa-4474-9ef9-0fa6835ff2fc.png)

扫描结束：

![image.png](https://cdn.nlark.com/yuque/0/2020/png/2398693/1605078888122-089135ca-8eb4-4a7c-9a4f-5b4f69762023.png)

点击名字就可以进去查看漏扫的结果：

![image.png](https://cdn.nlark.com/yuque/0/2020/png/2398693/1605078924740-568da93f-b133-4ec1-b99a-63ef18180e26.png)

![image.png](https://cdn.nlark.com/yuque/0/2020/png/2398693/1605078969629-55273858-a580-42e2-924f-5a10bbee3f17.png)

可以通过设置Filter优化显示，比如列出可以被利用的：

![image.png](https://cdn.nlark.com/yuque/0/2020/png/2398693/1605079013094-aab6e47b-63e1-4e33-92e5-5b02f0c7f999.png)

![image.png](https://cdn.nlark.com/yuque/0/2020/png/2398693/1605079019209-6693d27b-7931-420f-b944-9d32c6fbab80.png)

可以看到这个是分组显示的，我们可以设置为不分组，这样可以将全部漏洞按照严重程度排序：

![image.png](https://cdn.nlark.com/yuque/0/2020/png/2398693/1605079079842-eef42b4d-cec0-41c6-8550-556fc9649e0b.png)

![image.png](https://cdn.nlark.com/yuque/0/2020/png/2398693/1605079083791-db1633e0-6723-4c36-966f-c52afde80ba8.png)

点进每个漏洞的名字都有详细介绍，还会有链接引用。

#### Authenticated Scanning

新建一个Credentialed Patch Audit的扫描：

![image.png](https://cdn.nlark.com/yuque/0/2020/png/2398693/1605079251459-be56f006-7119-4e56-8130-f0afe8021771.png)

![image.png](https://cdn.nlark.com/yuque/0/2020/png/2398693/1605079255957-2a85db5a-1528-418e-9e1c-a5f26ce0f76b.png)

给扫描起名，然后确定目标，点击Credentials，填写指定的凭证，比如linux的一般是SSH：

![image.png](https://cdn.nlark.com/yuque/0/2020/png/2398693/1605079350730-66b4c4c6-6c26-4c34-afa6-2d87cf4a8650.png)

![image.png](https://cdn.nlark.com/yuque/0/2020/png/2398693/1605079355667-af97092c-0d2b-4c7a-8ad1-c85a1cd4db1d.png)

然后运行：

![image.png](https://cdn.nlark.com/yuque/0/2020/png/2398693/1605079366576-e66629d2-fbb7-4023-a07e-6dd1450240cd.png)

#### Scanning with Individual Nessus Plugins

Nessus可以定义仅使用部分插件去扫描，新建都是一样的步骤，主要是在输入名字和目标之后，点击上方的Plugins

![image.png](https://cdn.nlark.com/yuque/0/2020/png/2398693/1605079509416-2814ade2-887f-4955-a483-a9c8292915d7.png)

![image.png](https://cdn.nlark.com/yuque/0/2020/png/2398693/1605079519284-0529cbdb-b90e-43c2-80ad-399b4f14b670.png)

然后选择想要扫描的插件就可以了，左边是类别，右侧是具体的插件：

![image.png](https://cdn.nlark.com/yuque/0/2020/png/2398693/1605079578569-2b78873c-4765-4bd1-b3c9-f72559b18080.png)

然后运行即可：

![image.png](https://cdn.nlark.com/yuque/0/2020/png/2398693/1605079589967-25659585-4cc4-4bc6-9272-781aadc11394.png)

## Nmap 漏洞扫描

作为Nessus的替代方案，我们还可以使用Nmap脚本引擎(NSE)来执行自动的漏洞扫描。虽然NSE不是一个成熟的漏洞扫描器，但它确实有一个值得尊敬的脚本库，可以用来检测和验证漏洞。永远不要盲目地运行NSE脚本。在运行它们之前，花点时间检查它们以了解它们的功能，并尽可能在您自己的目标上进行测试。

在Kali上，NSE脚本可以在/usr/share/nmap/scripts/目录中找到。用任何文本编辑器打开.nse文件都可以显示每个脚本的源代码。花点时间检查一些NSE脚本，熟悉这些脚本执行的格式和检查类型。

这个文件夹还包含一个script.db文件，用作所有脚本的索引。它还对每个Nmap脚本进行了分类。例如，我们可以将grep文件用于“vuln”和“exploit”类别的脚本：

![image.png](https://cdn.nlark.com/yuque/0/2020/png/2398693/1605079939816-0bb53be9-2fa1-40c0-ace1-c97653b0b3a1.png)

比如用所有 ‘vuln’类型的脚本检测目标主机：

```
sudo nmap --script vuln 10.211.55.10
```