# 服务端模版注入

> Server-side template injection：https://portswigger.net/web-security/server-side-template-injection

## 什么是服务端模版注入？

服务器端模板注入是指攻击者能够使用本机模板语法将恶意负载注入到模板中，然后在服务器端执行该模板。

模板引擎被设计成通过结合固定模板和可变数据来生成web页面。当用户输入被直接连接到模板中，而不是作为数据传入时，服务器端模板注入攻击就会发生。这允许攻击者注入任意的模板指令来操作模板引擎，这通常使他们能够完全控制服务器。顾名思义，服务器端模板注入的有效负载是在服务器端交付和评估的，这可能使它们比典型的客户端模板注入更加危险。

## 服务端模版注入的影响

服务器端模板注入漏洞可以使网站暴露于各种攻击，这取决于所讨论的模板引擎以及应用程序使用它的确切方式。在某些罕见的情况下，这些漏洞不会构成真正的安全风险。然而，大多数时候，服务器端模板注入的影响可能是灾难性的。

在严重的情况下，攻击者可以实现远程代码执行，完全控制后端服务器并使用它对内部基础设施执行其他攻击。

即使在不可能完全执行远程代码的情况下，攻击者通常仍然可以使用服务器端模板注入作为许多其他攻击的基础，从而可能获得对服务器上敏感数据和任意文件的读访问权。

## 服务端模版注入漏洞是怎么产生的？

当用户输入被连接到模板中而不是作为数据传递时，就会出现服务器端模板注入漏洞。

静态模板只是提供用于呈现动态内容的占位符，通常不会受到服务器端模板注入的攻击。经典的例子是通过用户的名字来问候每个用户的电子邮件，例如下面从一个Twig模板中提取的内容:

```
$output = $twig->render("Dear {first_name},", array("first_name" => $user.first_name) );
```

这不会受到服务器端模板注入的攻击，因为用户的名字只是作为数据传递到模板中。

然而，由于模板只是字符串，web开发人员有时会在呈现之前直接将用户输入连接到模板中。让我们举一个与上面类似的例子，但是这一次，用户能够在发送邮件之前定制邮件的部分内容。例如，他们可以选择使用的名称:

```
$output = $twig->render("Dear " . $_GET['name']);
```

在这个例子中，不是将静态值传递到模板中，而是使用GET参数名动态生成模板本身的一部分。由于模板语法在服务器端进行评估，这可能允许攻击者将服务器端模板注入有效载荷放置在name参数内，如下所示:

```
http://vulnerable-website.com/?name={{bad-stuff-here}}
```

这样的漏洞有时是由不熟悉安全含义的人不熟悉模板设计而意外导致的。与上面的示例一样，您可能会看到不同的组件，其中一些组件包含连接并嵌入到模板中的用户输入。在某些方面，这类似于出现在编写得很差的预备语句中的SQL注入漏洞。

然而，有时这种行为实际上是有意实现的。例如，一些网站故意允许某些特权用户(如内容编辑器)根据设计编辑或提交自定义模板。如果攻击者能够攻击具有此类特权的帐户，这显然会带来巨大的安全风险。

## 构建一个服务端模版注入攻击

> 详细描述：https://portswigger.net/web-security/server-side-template-injection#constructing-a-server-side-template-injection-attack

Detect => Identify => Exploit =>（Read Explore Attack）

## 怎么阻止服务端模版注入漏洞？

防止服务器端模板注入的最佳方法是不允许任何用户修改或提交新模板。但是，由于业务需求的原因，这有时是不可避免的。

避免引入服务器端模板注入漏洞的最简单方法之一是，除非绝对必要，否则始终使用“无逻辑”模板引擎，如Mustache。尽可能地将逻辑与表示分离可以极大地减少最危险的基于模板的攻击。

另一种方法是只在沙箱环境中执行用户的代码，在这种环境中，潜在危险的模块和函数已经被完全删除。不幸的是，沙箱不受信任的代码从本质上来说是困难的，而且容易被绕过。

最后，另一种补充方法是当接受任意代码执行是不可避免的，通过应用您自己的沙箱将模板环境部署在一个锁定的Docker容器中。