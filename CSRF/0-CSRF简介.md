# CSRF（跨站请求伪造）

> 原网页：https://portswigger.net/web-security/csrf
>
> 实验室：https://portswigger.net/web-security/all-labs#cross-site-request-forgery-csrf

## 什么是CSRF？

跨站点请求伪造(也称为CSRF)是一个web安全漏洞，它允许攻击者诱导用户执行他们不打算执行的操作。它允许攻击者部分规避同源策略，该策略旨在防止不同网站相互干扰。

## CSRF攻击的影响

在成功的CSRF攻击中，攻击者会导致受害用户无意地执行某个动作。例如，这可能是更改他们帐户上的电子邮件地址，更改他们的密码，或进行资金转移。根据操作的性质，攻击者可能能够获得对用户帐户的完全控制。如果被攻击的用户在应用程序中具有特权角色，那么攻击者可能能够完全控制应用程序的所有数据和功能。

## 实施CSRF攻击的三个条件

- 一个相关的行动。应用程序中存在一个攻击者有理由诱导的动作。这可能是特权操作(比如修改其他用户的权限)，也可能是针对用户特定数据的任何操作(比如修改用户自己的密码)。
- 基于cookie会话处理。执行该操作涉及发出一个或多个HTTP请求，应用程序仅依赖会话cookie来识别发出请求的用户。没有其他机制可以跟踪会话或验证用户请求。
- 没有不可预测的请求参数。执行操作的请求不包含任何攻击者无法确定或猜测其值的参数。例如，当导致用户更改密码时，如果攻击者需要知道现有密码的值，则该函数不会受到攻击。

## 如何构造一个CSRF攻击的payload

> 这里说的是burpsuite的方法

- 在Burp Suite Professional的任何地方选择一个您想要测试或利用的请求。
- 从右键单击上下文菜单中，选择Engagement tools / Generate CSRF PoC。
- Burp套件将生成一些HTML来触发所选的请求(不包括cookie，它将由受害者的浏览器自动添加)。
- 您可以在CSRF PoC生成器中调整各种选项来微调攻击的各个方面。你可能需要在一些不寻常的情况下处理古怪的请求。
- 将生成的HTML复制到web页面中，在登录到易受攻击的web站点的浏览器中查看它，并测试是否成功发出了预期的请求以及是否发生了所需的操作。

## 怎样去实现一个CSRF漏洞

跨站点请求伪造攻击的传递机制与反射XSS的传递机制基本相同。通常，攻击者会将恶意HTML放到他们控制的web站点上，然后诱使受害者访问该web站点。这可以通过电子邮件或社交媒体消息向用户提供网站链接来实现。或者，如果攻击被放置在一个流行的web站点(例如，在一个用户评论中)，他们可能只是等待用户访问该web站点。

请注意，一些简单的CSRF利用使用GET方法，并且可以在易受攻击的web站点上使用单个URL完全自包含。在这种情况下，攻击者可能不需要使用外部站点，而可以直接向受害者提供脆弱域中的恶意URL。在前面的示例中，如果更改电子邮件地址的请求可以用GET方法执行，那么一个自包含的攻击就像这样:

```
<img src="https://vulnerable-website.com/email/change?email=pwned@evil-user.net">
```

## 如何防御CSRF攻击

> CSRF token：https://portswigger.net/web-security/csrf/tokens

防御CSRF攻击最健壮的方法是在相关请求中包含一个CSRF token。这个token应该是:

- - 与一般的会话令牌一样，在高熵下不可预测。
  - 绑定到用户的会话。
  - 在执行相关操作之前，在每个情况下都经过严格验证。

另一种对CSRF部分有效的防御方法是SameSite cookie，它可以与CSRF令牌一起使用。