# File Inclusion

> 参考1：https://www.freebuf.com/articles/web/182280.html
>
> 参考2：https://www.freebuf.com/company-information/221186.html

## 什么是文件包含？

服务器执行PHP文件时，可以通过文件包含函数加载另一个文件中的PHP代码，并且当PHP来执行，这会为开发者节省大量的时间。这意味着您可以创建供所有网页引用的标准页眉或菜单文件。当页眉需要更新时，您只更新一个包含文件就可以了，或者当您向网站添加一张新页面时，仅仅需要修改一下菜单文件（而不是更新所有网页中的链接）。

## 文件包含漏洞的原因？

文件包含函数加载的参数没有经过过滤或者严格的定义，可以被用户控制，包含其他恶意文件，导致了执行了非预期的代码。

## 文件包含的种类

本地文件包含（LFI）：可以结合目录穿越暴露敏感信息，也可以污染日志文件，包含日志文件显示RCE和get shell。

远程文件包含（RFI）：远程文件包含需要设置特定的选项，PHP应用程序必须配置allow_url_include设置为“On”，旧版本的默认开启。

php包装器（伪协议）：

![image.png](https://cdn.nlark.com/yuque/0/2020/png/2398693/1605194957599-4903e5a5-b8ee-440e-8baa-461fc3f1926c.png)

## 如何防御文件包含？

①严格判断包含中的参数是否外部可控，因为文件包含漏洞利用成功与否的关键点就在于被包含的文件是否可被外部控制；

②路径限制：限制被包含的文件只能在某一文件内，一定要禁止目录跳转字符，如：“../”；

③包含文件验证：验证被包含的文件是否是白名单中的一员；

④尽量不要使用动态包含，可以在需要包含的页面固定写好，如：include('head.php')。